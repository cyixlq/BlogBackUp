---
title: UHD630核显驱动方法及驱动后闪屏严重问题解决记录
date: 2018-12-10 15:34:32
tags: [显卡驱动,问题解决记录,黑苹果安装]
categories: 黑苹果
---
### 前言
之前我同学在公司申请了一个台式，硬件是由自己挑选，公司购买。于是乎，我和他一起挑选了兼容性较好的黑苹果硬件，前天组装好。然后就在昨天开始安装黑苹果。

<!-- more -->

### 同学的电脑硬件配置如下，给大家参考参考：
- CPU：i5-9600K（一开始推荐的八代U，后来因为和主板组合买便宜点，选了这个。在CPU的选购上大家直接买八代U就好了，当然九代也是可以安装黑苹果的）
- 主板：技嘉z370 HD3（因为加上CPU套装组合买便宜，因此也留下了一个坑。z370或者说370系列主板只支持八代U的，如果要支持九代U得先用八代U点亮后进入BISO升级一下BIOS版本）
- 电源：直接选了个300W功率的的，型号牌子什么的不记得了
- 机箱：这个直接跟着主板板型来选就好了，没什么特殊要求随便选选就好。因为我们选购的主板是ATX板型的，就直接选了个兼容ATX的机箱
- CPU散热器：买了个四铜管的散热器
- 内存条：买了两根16G的DDR4 2600Mhz的骇客神条
- 硬盘：512G Intel NVme固态硬盘
- 显示器：同学自己买的LG 2K宽屏
- 键鼠：随便买，能用就行，最好是插USB的
    
    其实挑好CPU和主板是最关键的。

### 开始安装
镜像：[【黑果小兵】macOS Mojave 10.14.2 18C54 正式版 with Clover 4792原版镜像](https://blog.daliansky.net/macOS-Mojave-10.14.2-18C54-official-version-with-Clover-4792-original-image.html)；下载完之后一定要校验一下MD5，确保完整性。

制作安装U盘：在另一个电脑上，Windows下使用TransMac制作好安装U盘，这个就不说了，网上一大堆教程。

BIOS设置：
- vt-d -> disable
- DVMT Pre-Allcated -> 128M (以后万一要接4K显示屏)
- DVMT Total Gfx Mem -> Max
- 快速启动（boot quick） -> disable

    这块主板发现就这几个地方需要改改，如果还有我没发现的，大家可以留言

开始安装：制作好之后，把U盘插在后置USB2.0接口。这里说一下，最好插后面的USB接口，而且最好插在USB2.0接口上，减少禁行的发生。之后从BIOS中选择从U盘启动，进入四叶草。光标移动到options选项，回车；configs，回车；选择了config_UHD630这个配置文件。之后return，选择boot macOS Install form Install macOS Mojave，然后就开始跑代码了。
![四叶草引导界面.jpg](/images/四叶草引导界面.jpg)
代码跑完之后出现苹果logo和进度条。进度条读完之后，进入了安装界面。先选择语言，当然选择简体中文啊。
![语言选择界面](/images/语言选择界面.jpg)
之后工具选择界面，先选择磁盘工具，然后左侧选择我们的硬盘，然后点击抹掉。名称自己随便取，英文的不要太长就好。我们取的APPLE SSD。下面这一栏格式选择Mac OS拓展（日志），接着下面一栏选择GUID分区表格式，点击抹掉，然后点击完成。因为这是一块新的硬盘，抹掉会自动有一个大于200M的EFI分区。

PS：如果你是已经装过Windows的硬盘，请确保你的EFI分区大于200M，否则会造成这一步抹盘失败。如果你的小于200M，给你一个比较好的解决办法。关机，拔下U盘，用一个装了PE的U盘启动，打开diskgenius磁盘管理工具，看看有没有MSR分区，有的话就右键这个分区，删除这个分区，然后右键EFI分区调整大小，直接把中间的杠杠拉倒最右边。如果没有的话，就悲催了，重新给你硬盘分一下区吧，这次记得把EFI分区调大一点。

抹盘这一步操作完成之后，我们就可以关掉磁盘工具了。这次我们点击安装Mac OS，出现硬盘选择界面，选择我们刚刚抹好的盘，名字是APPLE SSD。之后就是协议什么的，同意就行。然后就是一段时间的等待。NVme的速度不错，两三分钟就完成了第一部分的安装。机器自动重启！

重启后我们依旧从U盘启动，进入clover，选择options选项回车，选择configs回车，选择config_UHD630回车。然后return，这次我们选择的启动项是boot macOS Install from APPLE SSD（此处的APPLE SSD是我们之前抹盘的时候命名的名称，请根据你的实际情况选择）。然后开始跑代码，一切正常，出现苹果logo还有进度条。进度条下面出现了一行字，正在安装，剩余大约3分钟。
![安装第二阶段](/images/安装第二阶段.jpg)
这里说明一下，现在苹果系统安装有两个阶段，我的理解是上一步的安装是把苹果系统的安装程序复制到硬盘中，这一步是用硬盘中的安装程序把系统安装到硬盘上。以前我记得是只有一步的，这样做可能是为了提高安装系统的速度，毕竟从U盘中执行安装程序和硬盘中执行安装程序相比肯定是更慢的。好的，回到正题，等这一步安装完成之后，我们的系统才算是真正安装到硬盘了。机器依旧自动重启，还是选择从U盘进去clover，选择options选项回车，选择configs回车，选择config_UHD630回车。然后return，这次的启动项我们选择boot macOS from APPLE SSD（一样的，APPLE SSD是我们之前抹盘时候命名的硬盘名称，请根据你自己的实际情况来）。一样跑代码，一样正常显示苹果logo加进度条，然后进入了系统。然后是引导设置，这些很简单，自己按照引导设置。

### UHD630核显的驱动
进入系统后，点击左上角的小苹果图标/关于本机，发现显存只有7M，也就是意味着核显并没有驱动上。理论上最新版Lilu.kext加上whatevergreen.kext这两个驱动，只要配置文件中Graphics/Inject Intel勾选上就能原生注入驱动的。但是不知道我同学的怎么没驱动上。只好自己动手了，使用Intel FB Patcher这款软件，教程：[Intel FB-Patcher使用教程及插入姿势](https://blog.daliansky.net/Intel-FB-Patcher-tutorial-and-insertion-pose.html)。拓展阅读：[【黑苹果显卡驱动】通过Device/properties 给Framebuffer打补丁一点经验](https://www.jianshu.com/p/d3686b6f3ef6)。视频演示：[Intel FB-Patcher正确演示1102修改](https://www.bilibili.com/video/av35104213?from=search&seid=4950317082513025527)。不过在此之前，我们还是让系统脱离U盘引导。使用Clover Configurator这款软件（后文中简称CFG软件）点击左侧mount EFI选项卡，选择我们硬盘上的EFI分区。
![挂载EFI分区](/images/挂载EFI分区.png)
点击图中箭头所指的按钮后输入我们引导设置中设置的电脑密码就可以挂载硬盘上的EFI分区。同样使用这个方法也可以挂载U盘上的EFI分区。之后，我们把U盘中的efi分区EFI文件夹下的CLOVER文件夹和BOOT文件夹复制到硬盘efi分区的EFI文件夹下。复制好后打开硬盘中的EFI分区中的CLOVER文件夹，删除除去config_UHD630的其他plist配置文件，并且把config_UHD630.plist重命名为config.plist并且用CFG软件打开，点击左侧SMBIOS，右边点击一个上下在一起的箭头选择机型，以此来配置我们的黑苹果机型。我这里选择的是iMac18,3。
![如何使用CFG生成机型](/images/如何使用CFG生成机型.png)
现在就可以通过硬盘启动引导了，我们把U盘推出拔掉。下一段，我要好好说一下遇到的一些坑。

### 驱动核显遇到的坑
一开始用软件生成了config.plist文件放在桌面，使用CFG软件打开，同时打开硬盘EFI分区中的config文件。桌面的config文件使用CFG软件打开后，左侧选Devices，右下角点击Properties，可以看到需要打的补丁在里面了。在下面一小栏中左侧右键copy，粘贴到硬盘的EFI分区中的config文件对应位置。（上面视频演示中是直接把打好补丁的配置文件导出到硬盘EFI分区，这么做的话他会自动把补丁拷贝到硬盘的配置文件中，同时把原来的配置文件备份，我这里是手动复制过去）。补丁打好之后，重启发现显卡虽然驱动上了，显存2048M，但是屏幕一直在闪，眼睛都快要瞎掉那种。一开始我以为是因为同学2K屏屏幕的缘故，故调整一下参数：
- framebuffer-stolenmem:00003001 -> 00000008(19M改128M)
- framebuffer-unifiedmem:00000080 -> 000000C0(显存调整成3G)
- framebuffer-fbmem:00009000 -> 00000003(fb内存9M改48M)

添加一个参数：
- framebuffer-cursormem -> 00000003(cursor内存设置为48M)

修改好之后，保存，通过硬盘启动。竟然发现内核崩溃了，原因是framebuffer补丁没打好。
![内核崩溃](/images/内核崩溃.png)
可是我明明打了啊，还是按照高分屏来打的啊！后来我猜测，framebuffer-stolenmem翻译成中文意思是丢失的内存，作用可能是给BIOS中添加DVMT内存的。4K屏需要128M或以上，普通屏幕需要32M以上，而笔记本一般不能在bios设置这个，而一般大小可能是32M，具体多少我不清楚，所以只能通过这个补一个19M上去，这样就会大于32M了。可是要知道我们一开始在BIOS里面就设置成了128M，然后我们又加了一个128M，可能是这个DVMT内存过大导致补丁反而没打上去。有了这个猜想，用U盘引导启动，进入系统后我又把这个改回去了。之后关机，又用硬盘引导启动，发现能进去系统（原来我的猜想是正确的，吓得我赶紧去改了一下我的博客：[【黑苹果显卡驱动】通过Device/properties 给Framebuffer打补丁一点经验](https://www.jianshu.com/p/d3686b6f3ef6)）。显存也是3G，但是还是不停在闪屏。莫非闪屏不是这些的影响？幸运的是，在网上爬帖发现也有人遇到这个问题，驱动UHD630之后却一直在闪屏，他们通过把进行修改成iMac18,1解决了。原来这么简单就可以解决。果然，我使用CFG软件编辑硬盘上的config配置文件，修改SMBIOS为iMac18,1之后不会闪屏了。

### 声卡驱动
这一部分比较简单，因为这块主板声卡驱动有先例，我知道这块板子的layout-id该注入多少。（layout-id影响着声卡输出路线。个人理解：比如声卡通过什么线路输出到前置耳机孔、后置耳机孔、内置扬声器啊什么的。中文意思就是布局id，顾名思义，有点输出线路布局的味道。也就是声卡通过什么线路输出通过这个id决定，填对了才会有声音嘛。词穷，我也不知道怎么解释，想知道有哪些数字可以看我上一篇博客[《记一次黑苹果安装》](https://www.jianshu.com/p/8c9abd4f5b66)）。这块主板layout-id是92，我们通过CFG软件打开硬盘上的config配置文件，在图中位置填上92。
![声卡layout-id注入](/images/声卡layout-id注入.png)
然后打开硬盘EFI分区：CLOVER/kexts/other，打开这个文件夹之后打开这个文件夹下的`其他驱动`文件夹，把`AppleALC`最新版这个驱动放到`other`目录下。记得保存好配置文件之后重启一下，声卡就成功驱动上了。最后，附上一张关于本机图片：
![关于本机](/images/关于本机.jpg)